parameters:
  - name: resourceType
    type: object
  - name: outDir
    type: string
    default: infrastructure
  - name: isSolution
    type: string    
    default: "false"

steps:
  - checkout: ReleaseEngine

  - powershell: |
      if(${{ parameters.isSolution }} -ne "true")
      {
        $bicepFilePath = "/src/cloud/azure/${{ parameters.resourceType }}/${{ parameters.resourceType }}.bicep"
      }else{
        $bicepFilePath = "/src/solutions/azure/${{ parameters.resourceType }}/bicep/${{ parameters.resourceType }}.bicep"
      }

      if(Test-Path "$(Build.SourcesDirectory)/$(releaseEngineRepositoryName)"){
        $sourceDirectory = "$(Build.SourcesDirectory)/$(releaseEngineRepositoryName)"
      }else{
        $sourceDirectory = "$(Build.SourcesDirectory)"
      }

      $file = Join-Path $sourceDirectory $bicepFilePath

      Write-Host "##[section]Building bicep file: $file"

      Write-Host $file

      New-Item -ItemType Directory -Force -Path $(build.artifactstagingdirectory)/$env:outDir
      az bicep build --file $file --outdir $(build.artifactstagingdirectory)/$env:outDir

      Get-ChildItem $(build.artifactstagingdirectory)/$env:outDir
    displayName: 'Build bicep artifact' 
    env:
      outDir: ${{ parameters.outDir }}

      