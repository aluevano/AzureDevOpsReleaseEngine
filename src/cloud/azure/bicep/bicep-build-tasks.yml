parameters:
  - name: resource
    type: object
  - name: outDir
    type: string
    default: infrastructure
  - name: isSolution
    type: string    
    default: "false"
  - name: bicepFilePath
    type: string

steps:
  - checkout: ReleaseEngine

  - powershell: |
      Write-Host ${{ parameters.bicepFilePath }}

      $bicepFilePath = "${{ parameters.bicepFilePath }}"

      # if("${{ parameters.isSolution }}" -eq "true")
      # {
      #   $bicepFilePath = "/src/cloud/azure/${{ parameters.resource.type }}/${{ parameters.resource.type }}.bicep"
      # }else{
      #   $bicepFilePath = "/src/solutions/azure/${{ parameters.resource.type }}/bicep/${{ parameters.resource.type }}.bicep"
      # }

      if(Test-Path "$(Build.SourcesDirectory)/$(releaseEngineRepositoryName)"){
        $sourceDirectory = "$(Build.SourcesDirectory)/$(releaseEngineRepositoryName)"
      }else{
        $sourceDirectory = "$(Build.SourcesDirectory)"
      }

      $file = Join-Path $sourceDirectory $bicepFilePath

      Write-Host "##[section]Building bicep file: $file"

      Write-Host $file

      New-Item -ItemType Directory -Force -Path $(build.artifactstagingdirectory)
      az bicep build --file $file --outdir $(build.artifactstagingdirectory) --outfile ${{ parameters.resource.type }}

      Get-ChildItem $(build.artifactstagingdirectory)
    displayName: 'Build bicep artifact' 
    
  - task: PublishPipelineArtifact@1
    inputs:
      targetPath: $(build.artifactstagingdirectory)
      artifact: ${{ parameters.resource.name }}-iac
      publishLocation: pipeline      